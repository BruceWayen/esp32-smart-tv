#include "TftDriver.h"

namespace
{
const uint16_t COLOR_WHITE = 0xFFFF;

const uint8_t font5x7[] PROGMEM = {
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x5F,0x00,0x00,0x00,0x07,0x00,0x07,0x00,0x14,0x7F,0x14,0x7F,0x14,0x24,0x2A,0x7F,0x2A,0x12,0x23,0x13,0x08,0x64,0x62,0x36,0x49,0x55,0x22,0x50,0x00,0x05,0x03,0x00,0x00,0x00,0x1C,0x22,0x41,0x00,0x00,0x41,0x22,0x1C,0x00,0x14,0x08,0x3E,0x08,0x14,0x08,0x08,0x3E,0x08,0x08,0x00,0x50,0x30,0x00,0x00,0x08,0x08,0x08,0x08,0x08,0x00,0x60,0x60,0x00,0x00,0x20,0x10,0x08,0x04,0x02,0x3E,0x51,0x49,0x45,0x3E,0x00,0x42,0x7F,0x40,0x00,0x42,0x61,0x51,0x49,0x46,0x21,0x41,0x45,0x4B,0x31,0x18,0x14,0x12,0x7F,0x10,0x27,0x45,0x45,0x45,0x39,0x3C,0x4A,0x49,0x49,0x30,0x01,0x71,0x09,0x05,0x03,0x36,0x49,0x49,0x49,0x36,0x06,0x49,0x49,0x29,0x1E,0x00,0x36,0x36,0x00,0x00,0x00,0x56,0x36,0x00,0x00,0x08,0x14,0x22,0x41,0x00,0x14,0x14,0x14,0x14,0x14,0x00,0x41,0x22,0x14,0x08,0x02,0x01,0x51,0x09,0x06,0x32,0x49,0x79,0x41,0x3E,0x7E,0x11,0x11,0x11,0x7E,0x7F,0x49,0x49,0x49,0x36,0x3E,0x41,0x41,0x41,0x22,0x7F,0x41,0x41,0x22,0x1C,0x7F,0x49,0x49,0x49,0x41,0x7F,0x09,0x09,0x09,0x01,0x3E,0x41,0x49,0x49,0x7A,0x7F,0x08,0x08,0x08,0x7F,0x00,0x41,0x7F,0x41,0x00,0x20,0x40,0x41,0x3F,0x01,0x7F,0x08,0x14,0x22,0x41,0x7F,0x40,0x40,0x40,0x40,0x7F,0x02,0x0C,0x02,0x7F,0x7F,0x04,0x08,0x10,0x7F,0x3E,0x41,0x41,0x41,0x3E,0x7F,0x09,0x09,0x09,0x06,0x3E,0x41,0x51,0x21,0x5E,0x7F,0x09,0x19,0x29,0x46,0x46,0x49,0x49,0x49,0x31,0x01,0x01,0x7F,0x01,0x01,0x3F,0x40,0x40,0x40,0x3F,0x1F,0x20,0x40,0x20,0x1F,0x3F,0x40,0x38,0x40,0x3F,0x63,0x14,0x08,0x14,0x63,0x07,0x08,0x70,0x08,0x07,0x61,0x51,0x49,0x45,0x43,0x00,0x7F,0x41,0x41,0x00,0x02,0x04,0x08,0x10,0x20,0x00,0x41,0x41,0x7F,0x00,0x04,0x02,0x01,0x02,0x04,0x40,0x40,0x40,0x40,0x40,0x00,0x01,0x02,0x04,0x00,0x20,0x54,0x54,0x54,0x78,0x7F,0x48,0x44,0x44,0x38,0x38,0x44,0x44,0x44,0x20,0x38,0x44,0x44,0x48,0x7F,0x38,0x54,0x54,0x54,0x18,0x08,0x7E,0x09,0x01,0x02,0x0C,0x52,0x52,0x52,0x3E,0x7F,0x08,0x04,0x04,0x78,0x00,0x44,0x7D,0x40,0x00,0x20,0x40,0x44,0x3D,0x00,0x7F,0x10,0x28,0x44,0x00,0x00,0x41,0x7F,0x40,0x00,0x7C,0x04,0x18,0x04,0x78,0x7C,0x08,0x04,0x04,0x78,0x38,0x44,0x44,0x44,0x38,0x7C,0x14,0x14,0x14,0x08,0x08,0x14,0x14,0x18,0x7C,0x7C,0x08,0x04,0x04,0x08,0x48,0x54,0x54,0x54,0x20,0x04,0x3F,0x44,0x40,0x20,0x3C,0x40,0x40,0x20,0x7C,0x1C,0x20,0x40,0x20,0x1C,0x3C,0x40,0x30,0x40,0x3C,0x44,0x28,0x10,0x28,0x44,0x0C,0x50,0x50,0x50,0x3C,0x44,0x64,0x54,0x4C,0x44,0x00,0x08,0x36,0x41,0x00,0x00,0x00,0x7F,0x00,0x00,0x00,0x41,0x36,0x08,0x00,0x10,0x08,0x08,0x10,0x08,0x00,0x00,0x00,0x00,0x00
};

template <typename T>
void swapValue(T &a, T &b)
{
    T t = a;
    a = b;
    b = t;
}
} // namespace

TftDriver::TftDriver(uint8_t csPin, uint8_t dcPin, uint8_t rstPin, uint8_t mosiPin, uint8_t sclkPin)
    : _cs(csPin), _dc(dcPin), _rst(rstPin), _mosi(mosiPin), _sclk(sclkPin), _spi(HSPI)
{
}

void TftDriver::begin()
{
    pinMode(_cs, OUTPUT);
    pinMode(_dc, OUTPUT);
    pinMode(_rst, OUTPUT);

    digitalWrite(_cs, HIGH);
    digitalWrite(_dc, HIGH);
    digitalWrite(_rst, HIGH);

    _spi.begin(_sclk, -1, _mosi, _cs);
    _spi.setFrequency(40000000);
    _spi.setDataMode(SPI_MODE0);
    _spi.setBitOrder(MSBFIRST);

    tftInit();
    Serial.println("[显示] TFT 初始化完成");
}

void TftDriver::writeCommand(uint8_t cmd)
{
    digitalWrite(_dc, LOW);
    digitalWrite(_cs, LOW);
    _spi.transfer(cmd);
    digitalWrite(_cs, HIGH);
}

void TftDriver::writeData(uint8_t data)
{
    digitalWrite(_dc, HIGH);
    digitalWrite(_cs, LOW);
    _spi.transfer(data);
    digitalWrite(_cs, HIGH);
}

void TftDriver::writeData16(uint16_t data)
{
    digitalWrite(_dc, HIGH);
    digitalWrite(_cs, LOW);
    _spi.transfer16(data);
    digitalWrite(_cs, HIGH);
}

void TftDriver::tftInit()
{
    digitalWrite(_rst, LOW);
    delay(100);
    digitalWrite(_rst, HIGH);
    delay(120);

    writeCommand(0x3A);
    writeData(0x05);
    writeCommand(0xC5);
    writeData(0x1A);
    writeCommand(0x36);
    writeData(0x00);

    writeCommand(0xB2);
    writeData(0x05);
    writeData(0x05);
    writeData(0x00);
    writeData(0x33);
    writeData(0x33);

    writeCommand(0xB7);
    writeData(0x05);
    writeCommand(0xBB);
    writeData(0x3F);
    writeCommand(0xC0);
    writeData(0x2C);
    writeCommand(0xC2);
    writeData(0x01);
    writeCommand(0xC3);
    writeData(0x0F);
    writeCommand(0xC4);
    writeData(0x20);
    writeCommand(0xC6);
    writeData(0x01);
    writeCommand(0xD0);
    writeData(0xA4);
    writeData(0xA1);

    writeCommand(0x20);
    writeCommand(0x11);
    delay(120);
    writeCommand(0x29);
}

void TftDriver::setAddrWindow(uint16_t x0, uint16_t y0, uint16_t x1, uint16_t y1)
{
    writeCommand(0x2A);
    writeData16((x0 << 8) | (x0 & 0xFF));
    writeData16((x1 << 8) | (x1 & 0xFF));

    writeCommand(0x2B);
    writeData16((y0 << 8) | (y0 & 0xFF));
    writeData16((y1 << 8) | (y1 & 0xFF));

    writeCommand(0x2C);
}

void TftDriver::fillScreen(uint16_t color)
{
    fillRect(0, 0, WIDTH, HEIGHT, color);
}

void TftDriver::fillRect(int16_t x, int16_t y, int16_t w, int16_t h, uint16_t color)
{
    if (x >= WIDTH || y >= HEIGHT || w <= 0 || h <= 0)
        return;
    if (x + w > WIDTH)
        w = WIDTH - x;
    if (y + h > HEIGHT)
        h = HEIGHT - y;

    setAddrWindow(x, y, x + w - 1, y + h - 1);
    digitalWrite(_dc, HIGH);
    digitalWrite(_cs, LOW);
    for (uint32_t i = 0; i < static_cast<uint32_t>(w) * h; i++)
    {
        _spi.transfer16(color);
    }
    digitalWrite(_cs, HIGH);
}

void TftDriver::drawPixel(int16_t x, int16_t y, uint16_t color)
{
    if (x < 0 || x >= WIDTH || y < 0 || y >= HEIGHT)
        return;
    setAddrWindow(x, y, x, y);
    writeData16(color);
}

void TftDriver::drawLine(int16_t x0, int16_t y0, int16_t x1, int16_t y1, uint16_t color)
{
    int16_t steep = abs(y1 - y0) > abs(x1 - x0);
    if (steep)
    {
        swapValue(x0, y0);
        swapValue(x1, y1);
    }
    if (x0 > x1)
    {
        swapValue(x0, x1);
        swapValue(y0, y1);
    }

    int16_t dx = x1 - x0;
    int16_t dy = abs(y1 - y0);
    int16_t err = dx / 2;
    int16_t ystep = (y0 < y1) ? 1 : -1;

    for (; x0 <= x1; x0++)
    {
        if (steep)
            drawPixel(y0, x0, color);
        else
            drawPixel(x0, y0, color);
        err -= dy;
        if (err < 0)
        {
            y0 += ystep;
            err += dx;
        }
    }
}

void TftDriver::drawRect(int16_t x, int16_t y, int16_t w, int16_t h, uint16_t color)
{
    drawLine(x, y, x + w - 1, y, color);
    drawLine(x, y + h - 1, x + w - 1, y + h - 1, color);
    drawLine(x, y, x, y + h - 1, color);
    drawLine(x + w - 1, y, x + w - 1, y + h - 1, color);
}

void TftDriver::drawChar5x7(int16_t x, int16_t y, char c, uint16_t color, uint8_t size)
{
    if (c < 32 || c > 127)
        c = '?';

    uint16_t idx = (c - 32) * 5;
    for (uint8_t i = 0; i < 5; i++)
    {
        uint8_t line = pgm_read_byte(font5x7 + idx + i);
        for (uint8_t j = 0; j < 8; j++)
        {
            if (line & 0x1)
            {
                if (size == 1)
                    drawPixel(x + i, y + j, color);
                else
                    fillRect(x + i * size, y + j * size, size, size, color);
            }
            line >>= 1;
        }
    }
}

void TftDriver::drawText(int16_t x, int16_t y, const String &text, uint16_t color, uint8_t size)
{
    int16_t cursor = x;
    for (size_t i = 0; i < text.length(); i++)
    {
        drawChar5x7(cursor, y, text[i], color, size);
        cursor += 6 * size;
    }
}
