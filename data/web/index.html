<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ESP32-S3 Web配置</title>
  <style>
    body {
      font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
      background: #f6f7fb;
      margin: 0;
      padding: 20px;
      color: #222;
    }
    h1 {
      font-size: 22px;
      margin-bottom: 16px;
    }
    .card {
      background: #fff;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }
    .row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 8px;
    }
    label {
      min-width: 70px;
      font-weight: 600;
    }
    input, select, button {
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid #d0d5dd;
      font-size: 14px;
    }
    textarea {
      width: 100%;
      min-height: 180px;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #d0d5dd;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      line-height: 1.5;
      resize: vertical;
    }
    button {
      background: #4f46e5;
      color: #fff;
      border: none;
      cursor: pointer;
    }
    button.secondary {
      background: #64748b;
    }
    .alarm-row {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 6px;
    }
    .weather-block {
      font-size: 14px;
      line-height: 1.6;
      color: #334155;
    }
    .hint {
      font-size: 12px;
      color: #64748b;
    }
    .stack {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/pinyin-pro@3.20.4/dist/index.js"></script>
</head>
<body>
  <h1>ESP32-S3 Web配置</h1>

  <div class="card">
    <h2>WiFi配置</h2>
    <div class="row">
      <label for="ssid">SSID</label>
      <input id="ssid" type="text" placeholder="请输入WiFi名称" />
    </div>
    <div class="row">
      <label for="password">密码</label>
      <input id="password" type="password" placeholder="请输入WiFi密码" />
    </div>
    <button id="saveWifi">保存WiFi</button>
  </div>

  <div class="card">
    <h2>闹钟配置</h2>
    <div id="alarms"></div>
    <button id="addAlarm" class="secondary">添加闹钟</button>
    <button id="saveAlarms">保存闹钟</button>
  </div>

  <div class="card">
    <h2>区域与天气</h2>
    <div class="row">
      <label for="cityInput">城市</label>
      <input id="cityInput" type="text" placeholder="输入中文城市名" />
      <button id="lookupCity">查询城市</button>
    </div>
    <div class="row">
      <label for="citySelect">选择</label>
      <select id="citySelect"></select>
      <button id="saveCity">保存城市</button>
    </div>
    <p class="hint">提示：系统会先将中文转成拼音，再调用城市查询接口。</p>
    <div class="row">
      <button id="fetchNow">获取实时天气</button>
      <button id="fetch7d" class="secondary">获取7日天气</button>
    </div>
    <div id="weatherNow" class="weather-block"></div>
    <div id="weather7d" class="weather-block"></div>
  </div>

  <div class="card">
    <h2>主题自定义</h2>
    <div class="row">
      <button id="loadTheme" class="secondary">加载主题配置</button>
      <button id="saveTheme">保存主题配置</button>
      <button id="presetTheme" class="secondary">生成推荐布局</button>
    </div>
    <div class="stack">
      <textarea id="themeJson" placeholder="主题JSON配置"></textarea>
      <div class="row">
        <label for="themePath">保存路径</label>
        <input id="themePath" type="text" value="/config/theme.json" />
        <input id="themeFile" type="file" accept=".json" />
        <button id="uploadTheme" class="secondary">上传主题文件</button>
      </div>
      <p class="hint">提示：iconPath 支持使用 {code} 占位符，例如 /icons/weather/{code}.bmp。</p>
    </div>
  </div>

  <script>
    const alarmsContainer = document.getElementById("alarms");
    const citySelect = document.getElementById("citySelect");
    const themeTextarea = document.getElementById("themeJson");

    function createAlarmRow(alarm = { hour: 7, minute: 0, enabled: true, label: "" }) {
      const row = document.createElement("div");
      row.className = "alarm-row";
      row.innerHTML = `
        <input type="number" min="0" max="23" value="${alarm.hour}" class="alarm-hour" /> :
        <input type="number" min="0" max="59" value="${alarm.minute}" class="alarm-minute" />
        <input type="text" placeholder="标签" value="${alarm.label}" class="alarm-label" />
        <label>
          <input type="checkbox" class="alarm-enabled" ${alarm.enabled ? "checked" : ""} /> 启用
        </label>
        <button class="secondary remove-alarm">删除</button>
      `;
      row.querySelector(".remove-alarm").addEventListener("click", () => {
        row.remove();
      });
      alarmsContainer.appendChild(row);
    }

    function collectAlarms() {
      const rows = alarmsContainer.querySelectorAll(".alarm-row");
      return Array.from(rows).map(row => ({
        hour: parseInt(row.querySelector(".alarm-hour").value || 0, 10),
        minute: parseInt(row.querySelector(".alarm-minute").value || 0, 10),
        label: row.querySelector(".alarm-label").value || "",
        enabled: row.querySelector(".alarm-enabled").checked
      }));
    }

    function toPinyin(text) {
      if (window.pinyinPro && window.pinyinPro.pinyin) {
        return window.pinyinPro.pinyin(text, { toneType: "none", type: "array" }).join("");
      }
      return text;
    }

    async function loadConfig() {
      const res = await fetch("/api/config");
      const data = await res.json();
      document.getElementById("ssid").value = data.wifi?.ssid || "";
      document.getElementById("password").value = data.wifi?.password || "";

      alarmsContainer.innerHTML = "";
      const alarms = data.alarms || [];
      if (alarms.length === 0) {
        createAlarmRow();
      } else {
        alarms.forEach(createAlarmRow);
      }

      if (data.city?.id) {
        const option = document.createElement("option");
        option.value = data.city.id;
        option.textContent = data.city.name || data.city.id;
        citySelect.appendChild(option);
        citySelect.value = data.city.id;
      }
    }

    async function loadThemeConfig() {
      const res = await fetch("/api/theme");
      const text = await res.text();
      themeTextarea.value = text;
    }

    document.getElementById("saveWifi").addEventListener("click", async () => {
      const ssid = document.getElementById("ssid").value.trim();
      const password = document.getElementById("password").value.trim();
      await fetch("/api/wifi", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ ssid, password })
      });
      alert("WiFi配置已提交");
    });

    document.getElementById("addAlarm").addEventListener("click", () => createAlarmRow());

    document.getElementById("saveAlarms").addEventListener("click", async () => {
      const alarms = collectAlarms();
      await fetch("/api/alarms", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ alarms })
      });
      alert("闹钟配置已保存");
    });

    document.getElementById("lookupCity").addEventListener("click", async () => {
      const input = document.getElementById("cityInput").value.trim();
      if (!input) {
        alert("请输入城市名称");
        return;
      }
      const pinyin = toPinyin(input);
      const res = await fetch(`/api/city/lookup?keyword=${encodeURIComponent(pinyin)}`);
      const data = await res.json();
      citySelect.innerHTML = "";
      (data.locations || []).forEach(item => {
        const option = document.createElement("option");
        option.value = item.id;
        option.textContent = item.name;
        citySelect.appendChild(option);
      });
    });

    document.getElementById("saveCity").addEventListener("click", async () => {
      const selected = citySelect.options[citySelect.selectedIndex];
      if (!selected) {
        alert("请先选择城市");
        return;
      }
      await fetch("/api/city/select", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id: selected.value, name: selected.textContent })
      });
      alert("城市已保存");
    });

    document.getElementById("fetchNow").addEventListener("click", async () => {
      const res = await fetch("/api/weather/now");
      const data = await res.json();
      document.getElementById("weatherNow").textContent = JSON.stringify(data.now || data, null, 2);
    });

    document.getElementById("fetch7d").addEventListener("click", async () => {
      const res = await fetch("/api/weather/7d");
      const data = await res.json();
      document.getElementById("weather7d").textContent = JSON.stringify(data.daily || data, null, 2);
    });

    document.getElementById("loadTheme").addEventListener("click", loadThemeConfig);

    document.getElementById("saveTheme").addEventListener("click", async () => {
      const payload = themeTextarea.value.trim();
      if (!payload) {
        alert("主题配置不能为空");
        return;
      }
      const res = await fetch("/api/theme", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: payload
      });
      if (res.ok) {
        alert("主题配置已保存");
      } else {
        const err = await res.text();
        alert(`保存失败: ${err}`);
      }
    });

    document.getElementById("presetTheme").addEventListener("click", async () => {
      const res = await fetch("/api/theme/preset", { method: "POST" });
      if (res.ok) {
        await loadThemeConfig();
        alert("已生成推荐布局");
      } else {
        alert("生成失败");
      }
    });

    document.getElementById("uploadTheme").addEventListener("click", async () => {
      const fileInput = document.getElementById("themeFile");
      if (!fileInput.files.length) {
        alert("请选择要上传的主题文件");
        return;
      }
      const path = document.getElementById("themePath").value.trim() || "/config/theme.json";
      const formData = new FormData();
      formData.append("path", path);
      formData.append("file", fileInput.files[0]);
      const res = await fetch("/api/theme/upload", {
        method: "POST",
        body: formData
      });
      if (res.ok) {
        await loadThemeConfig();
        alert("主题文件已上传");
      } else {
        alert("上传失败");
      }
    });

    loadConfig();
    loadThemeConfig();
  </script>
</body>
</html>
